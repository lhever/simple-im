package com.lhever.common.core.support.token;

import com.lhever.common.core.support.logger.LogFactory;
import com.lhever.common.core.utils.Int2BinaryStringUtils;
import com.lhever.common.core.utils.Sha256Utils;
import org.apache.commons.codec.DecoderException;
import org.apache.commons.codec.binary.Hex;
import org.junit.Test;
import org.slf4j.Logger;

import java.io.*;
import java.util.Random;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * <p>
 * 类说明
 * </p>
 *
 * @author lihong10 2020/10/14 19:22
 * @version v1.0
 * @modificationHistory=========================逻辑或功能性重大变更记录
 * @modify by user: {修改人} 2020/10/14 19:22
 * @modify by reason:{方法名}:{原因}
 */
public class CustomTokenGenerator {

    private static final Logger logger = LogFactory.getLogger(CustomTokenGenerator.class);

    private static final String stringStore = "aced00057372003b636f6d2e68696b766973696f6e2e656974732e72686d2e636f72652e737570706f72742e746f6b656e2e43697263756c61724368617253746f7265000000000000002a0200015b000563686172737400025b437870757200025b43b02666b0e25d84ac020000787000001000002a0058004100250031003d0025006d005d005800240075005e00210042005c002f0076002a003f007e00460043005400730066006e006b0042007d006d00210041005400580022005c00560077004e00500047002e0039004200380074005a00540064003f005f00630043003200720060006d005e00550037007e00280069006f0029002c0046005c0075002e0054002a0050005e002e0067005c004a004300520033005b0046006e0061006b0037007b00720062002300480034005c0025006a00220075007d005e0056007a00730074007c004900420028004e006300700072005c003f00600058004900550032002500610059007c0037004d002b0032002500580042004000700030002a003f0040005c003f0054005c006b00460065005c003d002e006b0076002700230037006e006e0070005e00790045002c0042004100410031003a004500730075002800540042005c005c006300760078005c00570046005c0045003d007b0070006d006a00260047005800560039002b0070006e007e004b00490037005c0022007100430021005c002d006a006600670069005f0052003500570046007e00680043004c003d00320048005a007e007e0062002900670040006900350037005c00340047004600600066005c002e003b0074005c0036005400270066006c004d005a0041003a005b0025004a005c004a004b00370040003f00680066003e00600053002e0070005c007d002e0075002900630035005c002f005c0071006600770079002c00500047005c003f006a006f0076006d007e004600400071005c006c004e005e006d006400530065007a004c003a00530064005c00690036002b0067005c007e0030005c0039005c0053006a003100230042003d0027006a00390060007e005b002a007e0071003d006a003500700063002d0036004c00780079004000740069005100360066006f0060005e00780061002a003b002400590034005b003c00210041007000470032005e004000310027004400690043003b00220078007700380041003200630050006c004d005e00560044004f0040003b007400460051005e0057002e0045003a0033002b007d0036007b004a003c00290026005f0037004400530064005c005c0024006d005c005c0050002100660079005c005c0039003c00670064003400620032004a00390068004a0049006d0055004f0033006c0041004e007e0041002d007700680050003b0039005c003c005c0037004f005e005c0024002c005b0068005c0038004b0063005600540069005f003b003b0078006b00370058006c00730041002c005f0077005c0039005f005c002c003a007300420058005c002100360048005c007600460062006d005a007d0043005b004c0076002c0033007d006e002b0069006a0057004c004a0069005500440077004e002c005b005c0060006f0065003300260062005a00500052003e006d005c003a0047005600410034002d0069005e006000300053007a00540065003b006f00460076002300640054007d005c0052002e00250026004e0070005f0054005a00270073004b007e002d002a0053006a0045007b00420069007a006d0044002d004a0036005c005e005c005000410042006a00690073005a006f004200440049002400620055004d004f002b0060002d007700380046006300330056005c002e005c0022002100330026005a005c005c005b005c005f00280066004700630021002c00720067003600210071007b004b006d0056003d004c00680075006a00610074003f007d006d006c007800760065007c007a00640024004f00300025006c005c003300500056005c0060004000290041003700540037005c003d0041006c006300330026002100550055004500700066003f00290028005c00620046005c002a006d006f007e003f005c002b00250046002c002e005c005c0071005f003e005c0054002f0027002f006e0064002d0038002c00770075005e0073002c0033005f0062005c004b00230029004100330064005a005c00670071002f006b0066003600490048002e00270057004e0052007b0047006e0024005200270033007b005c0029002700260042006e005d004c004e006b00520050002c003e002400400055004d00300053002f005c0079007e00510030005800680032005c0068006e003b00520074005a006d0042006c002a005c00340071003400460051006d002b0067002f003f0025003d003e00410070006e002c002500490058003900440055005c0070005c006a0079005c0077005d006000450067005c003d002e0078005c00420041004b005c002a00250059006000540037003c004c004e003100270030005c005a005300660026005c005c0034003a00630065007e00750068003700260036002f007a003b00400058005500310034002c004d005c005600620071003a0059002a0025005c00530060003b0069002a004d0055005c002f0051004600400076005c005c004e0060006000740062006d00370029007700500027002c00280039002b003c005d0048007d005e006f004d007300740073004a0055007400220024002f002a003b002300730034006e006b002c0077006d005c005700450059004e005c00300079007b0061003d005c00670062006400620052006d0062005c00360055003f005c0022006a005c00410039004d002e0079006b005c006200550036005d0048004d005e0031005400580039007d00690079006f00270024004000670044006d00210043007500590053002f00480071006f003d0046006e0039004200490023005c002b005200720029002d00260071006e005c005c0077007a0050005b0049006b005c0042003c00710054005c004c004a005c0062002f004a00360056003e0078007a005a005c005c005c006d002d003600330047006e0022003b0078002f005c0060002b002f006c0072005c0034002a007b005b006300740054005c0051007e005c007800460052005f004300780032005e006d005800270075005900690053002f00790063007d0058004a006600370039005c0066007300440021002300260028004e00620032003400750032006c004e00480046003a0027003c004100430027005c007a005700670045006e002c002b0060005c00410063003b0026005c0071005900290038002f00780043006e00270027005c0060005c0054002f002f002e005c0032002d003c0057007c00250041002f005c002b004c00720072003e006d0039005c005c00360046007600740058004b0028003b005c005b0077002c0027003c004d007000540068003800490058005c006a0069005c002f003f006a005d0072005a0053003900610063004f0045005e003d00370076005c0064003100420074007600570073002300680054007500650051006e0035005d00280063002100220057006e005c005c006f006d005e0042004800590041004e005a002a0031003c007500280063005f005c002e0029005a005c0077006a004e0056005c007b00270042005a004d004b00780028006f0021006a006300270076007e006000730024006d006f007d0076005c0021005c00490022004d0066005c00460037005d007b005a006a006a0023004c003d0068003b006100600051005b0044005d00400071003a005000270023003b004a005c005d005c00720056004f005c004a00480053003e0076004e006d004200300071004a005c0059002a005c0038003d00540056004e0063003a002700590061004d003b00480046006800370043004500300050005c0024006b0042005c004f007d005e005c006900650052002b004c002900360049002b0071003e0054004a007e007a0065005f002e002a005400640079004000510078002a006e004d004a00510025005c00530045007b007b0042005a006200670049002e007400720060006a004d0064003300330031004900540027005c0077004d0067003b007c00520022005c007000600052003900390027002300240036003600780063006000470065003500320030005a006b0027004b0057003800360033006c002600250063005c0039005100660023005c005c005c006f0036004100770067003f005c00580040005c00450048003500760049007b0052006e003e003a005e00790051006d0038006a0076006300380059005c005c005c005c00740031007200240077004e0041003b0062005c002a00250069004b003b005c0054003a002e00280070002100580023006b006d005c0074003d005b0041007b004000500038007700300023004c0026006700580071007000640033007d005c005c002a00220041006b005b0069002200510071006c00330039004200600039004e0063007b0067007b006b0069007300510033006f0051003a006e0075005700330030005e006b002b0061007d00540059005a0024003b004a003100730058005000430021002e003d005c0025005900600065005c007c005d00580056003c0050002c006000670029004a002a00710077005900620060005c006b003f0069007a006200300046007400400037005c0064007b003f002d00230025004100270070005c005c002c004e0070002d003c0025006a004a0031005d005400510064002c006e004200350033004500260024006800370052005c0030007200370028005b003d004000270036003b0021002e005c005c006a005200360075002700220071005c006d0027003a004c002c0077005700550029005e005c0048006f0051004100310067005700740064005a005c003f005c002200470067003e00290055004e005f002500440037007b00470046006a00740038005c003200250050003d005c005c00350067004c004e0049005c005b00600044005c004f0051004d005c0078007a006300280032005e005900420053007d0033002600240069004900380050005e005c006d006b006d003e004f0034005c006e005c003800410054003a0024003c007a0032006b0042006a005a0062004600520025004c005c0067002e00260079002c004300610041007e005a002a005c002900370058003200400064002d0027003c00730061006d005a00540045005c00240069002900640073007500620032002600610078007a006300650049004b0022005c005c0050003c003d002a007b00460048005c002a00260032002100550032005c005c00220027005c0030007d007400690050002a004d00320053006000650073004d0025004a0027003500600079002800330025004e002700560060005d005c002c00250030007d0053006f0036005c0071007c005300550061002a005b00590044007a005c0024005c005f0042002c0030005c006c00570066006b0072005c0051003400260061005c007b002a0062005a0047005c0044005c004400760078006400380046004800400041006d0037006300790056005a006400550029002d004e004d0059006c00680058002b007d005d00790060007c0041006e00750067005a0033007c0025006e007d002a0034005c006f002f0053002100740038007d005b005c00350070002400480079006f006d003c0028004b007d003b006400730069006b00380041005c00600051005300740056007d0062007300340034005c005c0077004f00450070005c00370030005c0030007c006100610049005d006900380067006e007d002400450063005c005500520026005f00690067005c005b00670034002400780055006c004a0066005c0056002e004b00760027003c0059006b0053004000420040007d007e005600670037002f007600250072007c0021003400260077006d004000550048005c00350023004700340041004f002d00270026004e002d006f002d002b002e0052005c002800470070005c003e004e0043007b005c00380074003f005b00370028004e006e005700270035006000510029004b002d0077005c007c0024006f003c005500730038002f003c002d007d003f005c003500280063005c00300042004d0072007d004900350055005c0071002c0028007d0075003c002e006000440068007200560049005c007900670076004d00640053003f005f003d002500730063006f0036002f004500600022005c002b005e0033005c005c007a0045005c003d002200410068005c005d00790031004300520025005c006b00650070002a006f005c005f0062003600590028003d004300480072002d00280028005c004700560054005c0049003c002e005c005100460058007c0055006e0040002d0037005c004e0050005a006200390042002d003c005a006d00640066004c00270028005c007300770039005c0047004e0059005c0047002f006d0078002d007d007c005e002d0038004600730059004e005c005a007c004300490034005c007d007e004a002d0073002e007b0076006b003e005c005100540022005c006900540072003000560074002c0063007d003a004c0077006f007100320066002700410044005d002e0062004f00450034005e0046002f004c00250075007200530057004a005c003f0027007a0055005a005e003d0043002e002b00630052005c004c0021003d0041004c00370073002e003d005900550031005c00420063002c00760056004d003a005c007600660077005c002b00320064002a005f006300690042002b004d0073006a0039005c0062002a005e004a005c0026007e0044002d0038005c005c002a00430060003c005d0055005b005d002d00460024005e004a00380079004a006f0051002f00790060002300720049002d0071005c005d00240077006f004e0073004100640066007d004400400034007c00750070006a0043006400220076005c003500490047005c0022007a00770026005e005b007900700072004d004b0069007d005d00550041005c003100460066007c005c00750061004d006400570056003f003f006d002c0030007600580038002e002e006500440034007a006a005a0062005c004b006c0046007c005c005f005c007700640049007d0029002d007400710035004e0079002e002c003c005c00220079007e003d00560069004b005c0058006a002c006000720054007d005c00550061006000240031007700450050005c004700370042005e0030005c00540023002f003400270075003d004a00770062003b00400058005a0041005c00220029004f0069005d007b005c003c007d007200650048005100420076007e007c00450031005b005c006e007e00660064004a007e0071007600780036005900450047002c005100570059005c002800510047006100250039004d0075006b005400650064007a00440050005b0028004d005a005c002b0065004b002800480073005c002d003900680057002f004c002d002900510064005b005c003d005c00290070003d005d004f003e00210024007c0043002100400060006b003f007c00310033007a007e0074006e005c007a0028006e00600053002c0030005c004b005e005f0066003500410030005c004e00740041003500570025005a0035005f0044006e004f007800350057005c0029005a0076003a002300460048007a007800520073004f0032002f003f0047002f0062002f005e00710071003d00380077004d0044003a00300041006a007000650022005000350064007c00410061005c005a0062006c004f00640034003a005c0028003f0043004b003b00740078004a00360073005c006b0058005a0032005500230025003b004000720074005b0052003e0028005400700032005b007b002d005c0035004a0066002900700059006a007d005c0052005c007700520052002300280044007c00660061007b0021002c00750026006f00590077002c0037004900700052004f00390038007a003c00750041003a006a006b0054004200320057003f005c0026002c00740045005c0039002e002f005c00700035002b002c0032006b00410037003500650070002f006d006b0041003a00310037002e005c00680064003600730025002800510048003a005d0065005e006d003b005c005f00630070002c004b004d00420031003a0021007400730040006d005500770050005200450028007b0028004d005b005400550051002d003500700077004c0076004d0022003a00680027002b005c005d006d002e002c00470041005f007000760060002f0075006100750048003a00430045007700220069005a006b006a003500280051006f004c00570057002100350022007000310024002f00770059007100380049006b0079002c007400420062004800250045005e00780033005e00270070006e006500560039005d006d0061006d005a0062002c004f0076005e004c002c0067004d002f0053005c004c005c00300072005a0077004d003a005b007b007d005c004a0025006b00430050003a003d002a003c003a006a003d005b0054002d0062007c00220024006800250033007000300077005c005100770061004a00260043002c00690042004f00310028005c0047002f00630037003200290073002c002b00390045002c00230037003a00590021002300700061005a007d0032002f005e0029002600610074003d0036005c00280040003f0048005b0060006e00380022005c0073005c005500570043002e00470049002d0029005100480059003a002a0062007300570072007400220071005d007a00640073005c0048007c006a0065005c002b004d00540046006d0034005c005a006c006e002c003000430022004c006800280025003b00500041002b005c004b0070005c0074003a00510053004f0034005c002500490040006b006d004f0028005c006c005f007900240058005f00640024002c004f0032005c002a00640047005a0052002c005100710073005c00410039004a002f002a00610063005a0024006d007800770022005700470028005c0071005f005f005d0074004b002b005c004f0064002d0039005a004700240066003c0031003d0061007a0038002a0069007c003c006f004500760039005a005c005a0058005c003e004a00280078007a006c006e007700790077007d0062004a004f0051003c003d005d0058005c0023003f007300660036002c00450030006a005c006500490033003a007c003c00550073003b0069005e0057003d0054007b0039002400690046005400760036003f0056007200400027002900210033005c002100220027005c002a005c0053004400620029002d003c007600320058005a0066007c002e00740073006500790028002a0060006000650076006d005b0040005c0071006300330035003300280062006600240048007a0066004c007c004900360058005c006000690044005c004f004d00300074006b005c002e0034005b005c005a003e005c0053006f007e0079003300700076005c003b0040002500500054002b007a003a005c00250042003b005c003f006300540041002b005c0058005e007a0044005c00380030004f006100740062003a00360074002b007100580044002e006900780078003d00750050005a0030003a002300790041005c002b005c002c00390032004a003f0054004b0049004b005c005c0034003600420077006300480038003c005d0033004d004b005c007b005c005c005a0058002d00230068006e005b00300074005800730060004800260040004d003b0026004b006d005f004d0033005f00230075007c006a0041005c00660048006c0043005c00310058005c0051003c0050006f0062005c00720073003400360041002e006a0071006a0077003800390032002200660055002f002a00470045007d003e00320076007c0060007e00650027005c00450059003c005900540075002c00340075004d0064003f005c00360073005c007e004a0054006d006d0063007600790044005c006600290029004e00300041003e00680024004f005c004c00310054005100640021004c007b005c003e002c00680061002800700062005500570055007c006000280026005c005200690058003000240040002c005e002a0071005c004c004d00320047003d005f005c00560049004b005c0031006a0023005c0047006d005c0041004c0067005c00570029007b007000750031003800740079002f0026005200640071003e005c005c0023005f0061005a005c00650048005a005c004e0033004b0042005700450043003e0062005c005b005d00580078007c0049005c004e00450047005c005c006d003c007a004b0049003c005c005f0078007e006200530069003a005c0021004c004500750023002100230066002b005b0045004b0079006400530034002900500065004f00710039003b007a0052005b0078004b0042005f0070005d00560029007e004f0045005e003b006000480041002e00750068002c002e0052007b003e00770037006b0043003d005c0069005c00640051006d0039003200220075003f0030003b005c003c003e0035004b0030003b00650039005f002d00350065004b005b00680043005d006e003a00230063006e004c007a004b007d005c0060005a00510043003c005c005a0049006b005c004a0031007d00620044003e00330063002b0023004e0024005c005c0038005c005c006900530026002c003f007d00790075002b0066007b0057005d003c002b0048005e007e003a00770037003b005c0045006c006e00780062004e0054005c005c0052002e0039005c007d0071005c00560049007b0053002d0062006c007900470033003500740066003200410032007a007600690039004b0022005c00660065007100480044004e00400060004600620038007d0063003e00330048004e005c003a00770063004d0036004c006c0033002c005f0079005c0050004d006400330061005b003f0036005f00640061004b004b006a005c005c006c006e00450047005c00390030004b003200340023005c006800280026006d006c0043003a00290043004d00640029003f005c003d0077004f0040006000720054005c004d006200260031005d00550051005c005c005f0025002f007a00770026005e0026003e004b004100450023003d004a002b003e007c0037002d003c005c0066007a007e004f0071003e005c00470035005c0030007100270076004c007d0021005c0077006a004e0056005c007b00270042005a004d004b00780028006f0021006a006300270076007e006000730024006d006f007d0076005c0021005c00490022004d0066005c00460037005d007b005a006a006a0023004c003d0068003b006100600051005b0044005d00400071003a005000270023003b004a005c005d005c";
    private static CircularCharStore circularStore;

    private static final AtomicInteger atomicInteger = new AtomicInteger(0);

    static  {
        try {
            ByteArrayInputStream fin = new ByteArrayInputStream(Hex.decodeHex(stringStore));
            ObjectInputStream ois = new ObjectInputStream(fin);
            CircularCharStore oldStore = (CircularCharStore) ois.readObject();
            circularStore = oldStore;
        } catch (Throwable e) {
            logger.error("CircularCharStore init error", e);
        }
    }

    public static String generateToken(long timestamp, int messageSize, int secretOffset) {
        String colon = ":";
        long msgOffset = (circularStore.getLength() - 1) & timestamp;
        String message = timestamp + circularStore.slice((int) msgOffset, messageSize) + Int2BinaryStringUtils.toFullBinaryString(messageSize + secretOffset);
        String secret = circularStore.slice(secretOffset, 20) + Int2BinaryStringUtils.toFullBinaryString(timestamp + messageSize + secretOffset);
        String token = Sha256Utils.getHmacSHA256Base64String(message , secret);
        StringBuffer append = new StringBuffer().append(timestamp).append(colon).append((~messageSize)).append(colon).append((~secretOffset)).append(colon).append(token);
        return append.toString();
    }

    public static Random random() {
        int i = atomicInteger.addAndGet(777777);
        if (i < 0) {
            atomicInteger.set(0);
            i = 0;
        }
        Random random = new Random(System.currentTimeMillis() + i );//System.currentTimeMillis()短时间内调用，值相同，所以再增加一点波动
        return random;
    }

    public static String generateToken() {
        long now = System.currentTimeMillis();
        String token = generateToken(now, 32 + random().nextInt(65), random().nextInt(circularStore.getLength()));
        return token;
    }




    @Test
    public void test() {
//        System.out.println(token);

        for (int i = 0; i < 100000; i++) {
            String token = generateToken();
//            String token = generateToken();

            String[] split = token.split(":");
            Long timestamp = Long.valueOf(split[0]);
            int messageSize = ~Integer.valueOf(split[1]);
            int secretOffset = ~Integer.valueOf(split[2]);
            String newToken = generateToken(timestamp, messageSize, secretOffset);
            boolean equals = token.equals(newToken);
            if (!equals) {
                System.out.println(newToken);
            }
        }
    }


    public static void main (String args[]) throws IOException, ClassNotFoundException, DecoderException {

        CircularCharStore store = new CircularCharStore();
        ByteArrayOutputStream fout = new ByteArrayOutputStream(8192);
        ObjectOutputStream oos = new ObjectOutputStream(fout);
        oos.writeObject(store);
        oos.close();
        byte[] bytes = fout.toByteArray();

        String string = Hex.encodeHexString(bytes);
        System.out.println(string);


        ByteArrayInputStream fin = new ByteArrayInputStream(Hex.decodeHex(string));
        ObjectInputStream ois = new ObjectInputStream(fin);
        CircularCharStore oldStore = (CircularCharStore) ois.readObject();

        System.out.println(oldStore);
    }


}
